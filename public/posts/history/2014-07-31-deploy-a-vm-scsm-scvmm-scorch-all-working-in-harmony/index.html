<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>Deploy a VM – SCSM, SCVMM, SCORCH – all working in harmony</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description"
    content="This is meta description">
    
    
  <meta name="author" content="Themefisher">
  <meta name="generator" content="Hugo 0.89.1" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/themify-icons/themify-icons.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/images/favicon.png " type="image/x-icon">

  
  
  



<style type="text/css" media="screen">
  @media (prefers-color-scheme: dark) { 
    /* Background */ .chroma { color: #f8f8f2; background-color: #272822 }
/* Other */ .chroma .x {  }
/* Error */ .chroma .err { color: #960050; background-color: #1e0010 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
/* Keyword */ .chroma .k { color: #66d9ef }
/* KeywordConstant */ .chroma .kc { color: #66d9ef }
/* KeywordDeclaration */ .chroma .kd { color: #66d9ef }
/* KeywordNamespace */ .chroma .kn { color: #f92672 }
/* KeywordPseudo */ .chroma .kp { color: #66d9ef }
/* KeywordReserved */ .chroma .kr { color: #66d9ef }
/* KeywordType */ .chroma .kt { color: #66d9ef }
/* Name */ .chroma .n {  }
/* NameAttribute */ .chroma .na { color: #a6e22e }
/* NameBuiltin */ .chroma .nb {  }
/* NameBuiltinPseudo */ .chroma .bp {  }
/* NameClass */ .chroma .nc { color: #a6e22e }
/* NameConstant */ .chroma .no { color: #66d9ef }
/* NameDecorator */ .chroma .nd { color: #a6e22e }
/* NameEntity */ .chroma .ni {  }
/* NameException */ .chroma .ne { color: #a6e22e }
/* NameFunction */ .chroma .nf { color: #a6e22e }
/* NameFunctionMagic */ .chroma .fm {  }
/* NameLabel */ .chroma .nl {  }
/* NameNamespace */ .chroma .nn {  }
/* NameOther */ .chroma .nx { color: #a6e22e }
/* NameProperty */ .chroma .py {  }
/* NameTag */ .chroma .nt { color: #f92672 }
/* NameVariable */ .chroma .nv {  }
/* NameVariableClass */ .chroma .vc {  }
/* NameVariableGlobal */ .chroma .vg {  }
/* NameVariableInstance */ .chroma .vi {  }
/* NameVariableMagic */ .chroma .vm {  }
/* Literal */ .chroma .l { color: #ae81ff }
/* LiteralDate */ .chroma .ld { color: #e6db74 }
/* LiteralString */ .chroma .s { color: #e6db74 }
/* LiteralStringAffix */ .chroma .sa { color: #e6db74 }
/* LiteralStringBacktick */ .chroma .sb { color: #e6db74 }
/* LiteralStringChar */ .chroma .sc { color: #e6db74 }
/* LiteralStringDelimiter */ .chroma .dl { color: #e6db74 }
/* LiteralStringDoc */ .chroma .sd { color: #e6db74 }
/* LiteralStringDouble */ .chroma .s2 { color: #e6db74 }
/* LiteralStringEscape */ .chroma .se { color: #ae81ff }
/* LiteralStringHeredoc */ .chroma .sh { color: #e6db74 }
/* LiteralStringInterpol */ .chroma .si { color: #e6db74 }
/* LiteralStringOther */ .chroma .sx { color: #e6db74 }
/* LiteralStringRegex */ .chroma .sr { color: #e6db74 }
/* LiteralStringSingle */ .chroma .s1 { color: #e6db74 }
/* LiteralStringSymbol */ .chroma .ss { color: #e6db74 }
/* LiteralNumber */ .chroma .m { color: #ae81ff }
/* LiteralNumberBin */ .chroma .mb { color: #ae81ff }
/* LiteralNumberFloat */ .chroma .mf { color: #ae81ff }
/* LiteralNumberHex */ .chroma .mh { color: #ae81ff }
/* LiteralNumberInteger */ .chroma .mi { color: #ae81ff }
/* LiteralNumberIntegerLong */ .chroma .il { color: #ae81ff }
/* LiteralNumberOct */ .chroma .mo { color: #ae81ff }
/* Operator */ .chroma .o { color: #f92672 }
/* OperatorWord */ .chroma .ow { color: #f92672 }
/* Punctuation */ .chroma .p {  }
/* Comment */ .chroma .c { color: #75715e }
/* CommentHashbang */ .chroma .ch { color: #75715e }
/* CommentMultiline */ .chroma .cm { color: #75715e }
/* CommentSingle */ .chroma .c1 { color: #75715e }
/* CommentSpecial */ .chroma .cs { color: #75715e }
/* CommentPreproc */ .chroma .cp { color: #75715e }
/* CommentPreprocFile */ .chroma .cpf { color: #75715e }
/* Generic */ .chroma .g {  }
/* GenericDeleted */ .chroma .gd { color: #f92672 }
/* GenericEmph */ .chroma .ge { font-style: italic }
/* GenericError */ .chroma .gr {  }
/* GenericHeading */ .chroma .gh {  }
/* GenericInserted */ .chroma .gi { color: #a6e22e }
/* GenericOutput */ .chroma .go {  }
/* GenericPrompt */ .chroma .gp {  }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #75715e }
/* GenericTraceback */ .chroma .gt {  }
/* GenericUnderline */ .chroma .gl {  }
/* TextWhitespace */ .chroma .w {  }

  }
  @media (prefers-color-scheme: light) { 
    /* Background */ .chroma { background-color: #f8f8f8 }
/* Other */ .chroma .x {  }
/* Error */ .chroma .err {  }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
/* Keyword */ .chroma .k { color: #aa22ff; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #aa22ff; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #aa22ff; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #aa22ff; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #aa22ff }
/* KeywordReserved */ .chroma .kr { color: #aa22ff; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #00bb00; font-weight: bold }
/* Name */ .chroma .n {  }
/* NameAttribute */ .chroma .na { color: #bb4444 }
/* NameBuiltin */ .chroma .nb { color: #aa22ff }
/* NameBuiltinPseudo */ .chroma .bp {  }
/* NameClass */ .chroma .nc { color: #0000ff }
/* NameConstant */ .chroma .no { color: #880000 }
/* NameDecorator */ .chroma .nd { color: #aa22ff }
/* NameEntity */ .chroma .ni { color: #999999; font-weight: bold }
/* NameException */ .chroma .ne { color: #d2413a; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #00a000 }
/* NameFunctionMagic */ .chroma .fm {  }
/* NameLabel */ .chroma .nl { color: #a0a000 }
/* NameNamespace */ .chroma .nn { color: #0000ff; font-weight: bold }
/* NameOther */ .chroma .nx {  }
/* NameProperty */ .chroma .py {  }
/* NameTag */ .chroma .nt { color: #008000; font-weight: bold }
/* NameVariable */ .chroma .nv { color: #b8860b }
/* NameVariableClass */ .chroma .vc {  }
/* NameVariableGlobal */ .chroma .vg {  }
/* NameVariableInstance */ .chroma .vi {  }
/* NameVariableMagic */ .chroma .vm {  }
/* Literal */ .chroma .l {  }
/* LiteralDate */ .chroma .ld {  }
/* LiteralString */ .chroma .s { color: #bb4444 }
/* LiteralStringAffix */ .chroma .sa { color: #bb4444 }
/* LiteralStringBacktick */ .chroma .sb { color: #bb4444 }
/* LiteralStringChar */ .chroma .sc { color: #bb4444 }
/* LiteralStringDelimiter */ .chroma .dl { color: #bb4444 }
/* LiteralStringDoc */ .chroma .sd { color: #bb4444; font-style: italic }
/* LiteralStringDouble */ .chroma .s2 { color: #bb4444 }
/* LiteralStringEscape */ .chroma .se { color: #bb6622; font-weight: bold }
/* LiteralStringHeredoc */ .chroma .sh { color: #bb4444 }
/* LiteralStringInterpol */ .chroma .si { color: #bb6688; font-weight: bold }
/* LiteralStringOther */ .chroma .sx { color: #008000 }
/* LiteralStringRegex */ .chroma .sr { color: #bb6688 }
/* LiteralStringSingle */ .chroma .s1 { color: #bb4444 }
/* LiteralStringSymbol */ .chroma .ss { color: #b8860b }
/* LiteralNumber */ .chroma .m { color: #666666 }
/* LiteralNumberBin */ .chroma .mb { color: #666666 }
/* LiteralNumberFloat */ .chroma .mf { color: #666666 }
/* LiteralNumberHex */ .chroma .mh { color: #666666 }
/* LiteralNumberInteger */ .chroma .mi { color: #666666 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #666666 }
/* LiteralNumberOct */ .chroma .mo { color: #666666 }
/* Operator */ .chroma .o { color: #666666 }
/* OperatorWord */ .chroma .ow { color: #aa22ff; font-weight: bold }
/* Punctuation */ .chroma .p {  }
/* Comment */ .chroma .c { color: #008800; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #008800; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #008800; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #008800; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #008800; font-weight: bold }
/* CommentPreproc */ .chroma .cp { color: #008800 }
/* CommentPreprocFile */ .chroma .cpf { color: #008800 }
/* Generic */ .chroma .g {  }
/* GenericDeleted */ .chroma .gd { color: #a00000 }
/* GenericEmph */ .chroma .ge { font-style: italic }
/* GenericError */ .chroma .gr { color: #ff0000 }
/* GenericHeading */ .chroma .gh { color: #000080; font-weight: bold }
/* GenericInserted */ .chroma .gi { color: #00a000 }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #000080; font-weight: bold }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #800080; font-weight: bold }
/* GenericTraceback */ .chroma .gt { color: #0044dd }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }
 
  }
  </style>

</head><body>
    
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="fixed-top navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-light bg-transparent">
      <a class="navbar-brand"href="https://flkellyneucloudblogpre.z16.web.core.windows.net/"><img class="img-fluid" src="/images/logo.svg" alt="Fletcher Kelly | Cloud Engineer"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/"> Home </a>
          </li>
          
        </ul>
        
        <!-- search -->
        <div class="search">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://flkellyneucloudblogpre.z16.web.core.windows.net/search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation --> <div class="py-5 d-none d-lg-block"></div> 

<section class="section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto block shadow mb-5">
        <h2>Deploy a VM – SCSM, SCVMM, SCORCH – all working in harmony</h2>
        <div class="mb-3 post-meta">
          <a href="/author/fletcher-kelly">Fletcher Kelly</a>,
          Jul 31, 2014, 
          <a href="/categories/virtual-machine-manager">Virtual Machine Manager</a>
          
          <a href="/categories/powershell">PowerShell</a>
          
          <a href="/categories/system-center">System Center</a>
          
          <a href="/categories/orchestrator">Orchestrator</a>
          
          <a href="/categories/service-manager">Service Manager</a>
          
        </div>
        
        <div class="content mb-5">
          <!-- raw HTML omitted -->
<p>So, it has been a while.</p>
<p>So, the requirement for this project was as follow.</p>
<ol>
<li>Use Service Manager.</li>
<li>Provide a portal for logging a VM Creation request.</li>
<li>Build the computername based on a predetermined pattern.</li>
<li>Determine first available name.</li>
<li>Perform a capacity check.</li>
<li>Deploy the set number of VMs.</li>
</ol>
<p>I am going to skip over the first 2 Points, there are numerous topics covering this. So, onto point 3, I created a Service Request Extension, if anyone would like some info on this, also plenty of articles, please let me know and I can do a blog post on the Extension, or I can make the extension available for you to seal yourselves. Anyways, I mapped all the prompts required within the Request Offering and published it to SharePoint Service Manager Portal.</p>
<p>So, now it is onto the Computername Pattern, for the sake of my customer&rsquo;s privacy, I will not use there exact naming pattern, but rather use XX-YY-Z type of naming, to give you the idea. Of course, Loving <a href="https://docs.microsoft.com/en-us/powershell/scripting/overview?view=powershell-7.1">PowerShell</a> the way I do, I turned to old faithful.</p>
<p>I will provide the basic PowerShell code in snippets and allow you to expand onto it as you see fit, I built in a fair amount of specific error checking for my customer which will NOT be included in this post.</p>
<p>The <a href="http://www.quest.com/powershell/activeroles-server.aspx">Quest Commandlets</a> will be needed for these scripts. The code is being re-formatted due to the blog hoster. Please change the required values.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c">#build computer name</span>

<span class="nv">$businessApplication</span> <span class="p">=</span> <span class="s2">&#34;&lt;&gt;&#34;</span> <span class="c">#now from ORC as part of SR  </span>
<span class="nv">$function</span> <span class="p">=</span> <span class="s2">&#34;&lt;&gt;&#34;</span> <span class="c">#now from ORC as part of SR  </span>
<span class="nv">$location</span> <span class="p">=</span> <span class="s2">&#34;&lt;&gt;&#34;</span> <span class="c">#now from ORC as part of SR  </span>
<span class="nv">$affinity</span> <span class="p">=</span> <span class="s2">&#34;&lt;&gt;&#34;</span> <span class="c">#now from ORC as part of SR  </span>
<span class="nv">$role</span> <span class="p">=</span> <span class="s2">&#34;&lt;&gt;&#34;</span> <span class="c">#now from ORC as part of SR  </span>
<span class="nv">$businessUnit</span> <span class="p">=</span> <span class="s2">&#34;&lt;&gt;&#34;</span> <span class="c">#now from ORC as part of SR</span>

<span class="c">#naming convention  </span>
<span class="c">#1 letter - BusinessUnit  </span>
<span class="nv">$businessUnit</span> <span class="p">=</span> <span class="nv">$businessUnit</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">1</span><span class="p">)</span>  
<span class="nv">$businessApplication</span>  
<span class="c">#3 letters - location  </span>
<span class="nv">$location</span> <span class="p">=</span> <span class="nv">$location</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">3</span><span class="p">)</span>  
<span class="nv">$location</span>

<span class="c">#placecholder (-)</span>

<span class="c">#1 letter - role  </span>
<span class="nv">$role</span> <span class="p">=</span> <span class="nv">$role</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">1</span><span class="p">)</span>  
<span class="nv">$role</span>

<span class="c">#1 letter - Function  </span>
<span class="nv">$function</span> <span class="p">=</span> <span class="nv">$function</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">1</span><span class="p">)</span>  
<span class="nv">$function</span>

<span class="c">#tiebreaker (XXX)</span>

<span class="c">#3 Letters &amp;#8211; Business Application  </span>
<span class="nv">$businessApplication</span> <span class="p">=</span> <span class="nv">$businessApplication</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">3</span><span class="p">)</span>  
<span class="nv">$businessApplication</span>

<span class="c">#1 letter - Affinity  </span>
<span class="nv">$affinity</span> <span class="p">=</span> <span class="nv">$affinity</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">1</span><span class="p">)</span>  
<span class="nv">$affinity</span>

<span class="nv">$computernamepattern</span> <span class="p">=</span> <span class="nv">$businessUnit</span> <span class="p">+</span> <span class="nv">$location</span> <span class="p">+</span><span class="s2">&#34;-&#34;</span><span class="p">+</span> <span class="nv">$role</span> <span class="p">+</span> <span class="nv">$function</span><span class="p">+</span><span class="s2">&#34;XXX&#34;</span> <span class="p">+</span> <span class="nv">$businessApplication</span><span class="p">+</span><span class="nv">$affinity</span>  
<span class="nv">$computernamepattern</span>

<span class="nv">$computernametocheck</span> <span class="p">=</span> <span class="nv">$computernamepattern</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s2">&#34;XXX&amp;&#34;</span><span class="p">,</span><span class="s2">&#34;001&#34;</span><span class="p">)</span>  
<span class="nv">$computernametocheck</span>

<span class="nv">$part1</span> <span class="p">=</span> <span class="nv">$computernamepattern</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">7</span><span class="p">)</span>  
<span class="nv">$part3</span> <span class="p">=</span> <span class="nv">$computernamepattern</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">10</span><span class="p">,</span><span class="n">4</span><span class="p">)</span>  
<span class="nv">$part2</span> <span class="p">=</span> <span class="nv">$computernamepattern</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">7</span><span class="p">,</span><span class="n">3</span><span class="p">)</span>

<span class="c">#==============================================================  </span>
<span class="c">#Check if computer name exists</span>

<span class="nb">Add-PSSnapin</span> <span class="n">quest</span><span class="p">.</span><span class="n">ActiveRoles</span><span class="p">.</span><span class="n">ADManagement</span>  
<span class="nv">$i</span> <span class="p">=</span> <span class="n">1</span>  
<span class="k">do</span>  
<span class="p">{</span>  
<span class="nv">$computername</span> <span class="p">=</span> <span class="nv">$part1</span> <span class="p">+</span> <span class="s2">&#34;{0:D3}&#34;</span><span class="p">;</span> <span class="o">-f</span> <span class="nv">$i</span> <span class="p">+</span> <span class="nv">$part3</span>  
<span class="s2">&#34;;testing $computername&#34;</span><span class="p">;</span>  
<span class="nv">$test</span> <span class="p">=</span> <span class="nb">get-qadcomputer</span> <span class="nv">$computername</span>  
<span class="k">if</span> <span class="p">(</span><span class="nv">$test</span><span class="p">)</span>  
<span class="p">{</span><span class="s2">&#34;Computer Exists&#34;</span><span class="p">}</span>  
<span class="k">Else</span>  
<span class="p">{</span><span class="nv">$computerstartname</span> <span class="p">=</span> <span class="nv">$computername</span><span class="p">}</span>  
<span class="nv">$i</span><span class="p">++</span>  
<span class="p">}</span>  
<span class="k">until</span> <span class="p">(</span><span class="nv">$computerstartname</span> <span class="o">-ne</span> <span class="nv">$null</span><span class="p">)</span>

<span class="c">#==========================================================  </span>
<span class="c">#create computers</span>

<span class="nv">$part1</span> <span class="p">=</span> <span class="nv">$computerstartname</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">7</span><span class="p">)</span>  
<span class="nv">$part3</span> <span class="p">=</span> <span class="nv">$computerstartname</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">10</span><span class="p">,</span><span class="n">4</span><span class="p">)</span>  
<span class="nv">$part2</span> <span class="p">=</span> <span class="nv">$computerstartname</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">7</span><span class="p">,</span><span class="n">3</span><span class="p">)</span>  
<span class="no">[int]</span><span class="nv">$partnumber</span> <span class="p">=</span> <span class="nv">$part2</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">2</span><span class="p">,</span><span class="n">1</span><span class="p">)</span>  
<span class="nv">$computerstobeCreated</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>  
<span class="nv">$computersRequested</span> <span class="p">=</span> <span class="s2">&#34;Value_from_Orc&#34;</span><span class="p">;</span>

<span class="nv">$computersCreated</span> <span class="p">=</span> <span class="n">0</span>  
<span class="nv">$filepath</span> <span class="p">=</span> <span class="s2">&#34;C:\Tools\testing.txt&#34;</span><span class="p">;</span>  
<span class="nb">New-Item</span> <span class="n">-Path</span> <span class="nv">$filepath</span> <span class="n">-ItemType</span> <span class="n">file</span>

<span class="k">do</span>  
<span class="p">{</span>  
<span class="nv">$newcomputer</span> <span class="p">=</span> <span class="nv">$part1</span> <span class="p">+</span> <span class="s2">&#34;{0:D3}&#34;</span><span class="p">;</span> <span class="o">-f</span> <span class="nv">$partnumber</span> <span class="p">+</span> <span class="nv">$part3</span>  
<span class="c">#New-QADComputer -Name $newcomputer -ParentContainer &#34;;OU=Test Computer Accounts,OU=System Accounts,DC=bui,DC=co,DC=za&#34;;  </span>
<span class="nb">write-host</span> <span class="nv">$newcomputer</span>  
<span class="nb">write-host</span> <span class="nv">$computersCreated</span>  
<span class="nb">Add-Content</span> <span class="n">-Path</span> <span class="nv">$filepath</span> <span class="n">-Value</span> <span class="nv">$newcomputer</span>  
<span class="nv">$computersCreated</span><span class="p">++</span>  
<span class="nv">$partnumber</span><span class="p">++</span>  
<span class="nv">$computerstobeCreated</span> <span class="p">=</span> <span class="nv">$computerstobeCreated</span> <span class="p">+</span> <span class="s2">&#34;&#34;</span> <span class="p">+</span> <span class="nv">$newcomputer</span>  
<span class="p">}</span>  
<span class="k">while</span> <span class="p">(</span><span class="nv">$computersCreated</span> <span class="o">-le</span> <span class="p">(</span><span class="nv">$computersRequested</span><span class="p">-</span><span class="n">1</span><span class="p">))</span>

<span class="nv">$computerstobeCreated</span> <span class="p">=</span> <span class="nv">$computerstobeCreated</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">1</span><span class="p">)</span>

</code></pre></div><p>I  check the nodes within the Cluster and then find the node with the least amount of Virtual Machines on it. Then use this node information for the creation of the VM. Now time for the free space, since this was a Cluster. I get all the CSV information and then sort by the free space and select the first object as this one would have the most amount of free space.</p>
<p>This is a basic capacity check as per the customer&rsquo;s requirement, as part of this a field within Service Manager is updated to allow some more information to be shared within the members of the team working on this request.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c">#==========================================================  </span>
<span class="c">#Check for placement issues</span>

<span class="nv">$VMCluster</span> <span class="p">=</span> <span class="s2">&#34;&lt;&gt;&#34;</span>

<span class="nv">$VMMServer</span> <span class="p">=</span> <span class="s2">&#34;&lt;&gt;&#34;</span>

<span class="nv">$numberOfVMS</span> <span class="p">=</span> <span class="s2">&#34;&lt;&gt;&#34;</span>

<span class="nv">$hostmachinedomain</span> <span class="p">=</span> <span class="p">(</span><span class="nb">gwmi </span><span class="n">WIN32_ComputerSystem</span> <span class="n">-ComputerName</span> <span class="nv">$VMMServer</span><span class="p">).</span><span class="n">Domain</span>

<span class="nv">$ClusterFQDN</span> <span class="p">=</span> <span class="nv">$VMCluster</span> <span class="p">+</span> <span class="s2">&#34;.&#34;</span> <span class="p">+</span><span class="nv">$hostmachinedomain</span>

<span class="nv">$nodes</span> <span class="p">=</span> <span class="p">(</span><span class="nb">get-scvmhostcluster</span> <span class="n">-Name</span> <span class="nv">$VMCluster</span><span class="p">).</span><span class="n">nodes</span> 

<span class="nv">$colPlacementInfo</span> <span class="p">=</span> <span class="p">@()</span>

<span class="c">#$placementInfo = New-Object system.object</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$node</span> <span class="k">in</span> <span class="nv">$nodes</span><span class="p">)</span>  
<span class="p">{</span>  
<span class="nv">$placementInfo</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">system</span><span class="p">.</span><span class="n">object</span>

<span class="nv">$placement</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-SCVMHost</span> <span class="nv">$node</span><span class="p">).</span><span class="n">AvailableForPlacement</span>

<span class="k">switch</span><span class="p">(</span><span class="nv">$placement</span><span class="p">)</span>  
<span class="p">{</span>  
  <span class="s2">&#34;True&#34;</span>  
<span class="p">{</span>  
<span class="nv">$placementInfo</span> <span class="p">|</span> <span class="nb">Add-Member</span> <span class="n">NoteProperty</span> <span class="n">-name</span> <span class="n">Placement</span> <span class="n">-value</span> <span class="s2">&#34;True&#34;</span><span class="p">;</span>  
<span class="p">}</span>  
<span class="s2">&#34;False&#34;</span>  
<span class="p">{</span>  
<span class="nv">$placementInfo</span> <span class="p">|</span> <span class="nb">Add-Member</span> <span class="n">NoteProperty</span> <span class="n">-name</span> <span class="n">Placement</span> <span class="n">-value</span> <span class="s2">&#34;False&#34;</span><span class="p">;</span>  
<span class="p">}</span>  
<span class="p">}</span>  
<span class="nv">$colPlacementInfo</span> <span class="p">+=</span> <span class="nv">$placementInfo</span>  
<span class="p">}</span> 

<span class="k">If</span> <span class="p">(</span><span class="nv">$colPlacementInfo</span><span class="p">.</span><span class="n">placement</span> <span class="o">-ccontains</span> <span class="s2">&#34;False&#34;</span><span class="p">;)</span>  
<span class="p">{</span><span class="nv">$Proceed</span><span class="p">=</span><span class="s2">&#34;No&#34;</span><span class="p">}</span>  
<span class="k">else</span>  
<span class="p">{</span><span class="nv">$Proceed</span><span class="p">=</span><span class="s2">&#34;Yes&#34;</span><span class="p">}</span>

<span class="c">#capacity check</span>

<span class="nv">$VMCluster</span> <span class="p">=</span> <span class="s2">&#34;&lt;value_from_orc&gt;&#34;</span>

<span class="nv">$VMMServer</span> <span class="p">=</span> <span class="s2">&#34;&lt;value_from_orc&gt;&#34;</span>

<span class="nv">$numberOfVMS</span> <span class="p">=</span> <span class="s2">&#34;&lt;value_from_orc&gt;&#34;</span>

<span class="nv">$hostmachinedomain</span> <span class="p">=</span> <span class="p">(</span><span class="nb">gwmi </span><span class="n">WIN32_ComputerSystem</span> <span class="n">-ComputerName</span> <span class="nv">$VMMServer</span><span class="p">).</span><span class="n">Domain</span>

<span class="nv">$ClusterFQDN</span> <span class="p">=</span> <span class="nv">$VMCluster</span> <span class="p">+</span><span class="s2">&#34;;.&#34;</span><span class="p">;+</span><span class="nv">$hostmachinedomain</span>

<span class="nv">$nodes</span> <span class="p">=</span> <span class="p">(</span><span class="nb">get-scvmhostcluster</span> <span class="n">-Name</span> <span class="nv">$VMCluster</span><span class="p">).</span><span class="n">nodes</span> 

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$node</span> <span class="k">in</span> <span class="nv">$nodes</span><span class="p">)</span>  
<span class="p">{</span>  
<span class="c">#get Memory Information  </span>
<span class="nv">$memoryAvailable</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-SCVMHost</span> <span class="nv">$node</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">AvailableMemory</span> <span class="c"># MB  </span>
<span class="nv">$memoryAvailableCluster</span> <span class="p">=</span> <span class="nv">$memoryAvailableCluster</span> <span class="p">+</span> <span class="nv">$memoryAvailable</span>

<span class="no">[int]</span><span class="nv">$memoryTotal</span> <span class="p">=</span> <span class="p">((</span><span class="nb">Get-SCVMHost</span> <span class="nv">$node</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">TotalMemory</span><span class="p">)</span> <span class="p">/</span><span class="n">1mb</span> <span class="c">#bytes &#34;{0:D3}&#34; -f  </span>
<span class="nv">$memoryTotalCluster</span> <span class="p">=</span> <span class="nv">$memoryTotalCluster</span> <span class="p">+</span> <span class="nv">$memoryTotal</span>

<span class="c">#get CPU Information  </span>
<span class="nv">$CpuCoreCount</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-SCVMHost</span> <span class="nv">$node</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">CoresPerCpu</span>  
<span class="nv">$CpuCoreTotalCluster</span> <span class="p">=</span> <span class="nv">$CpuCoreTotalCluster</span> <span class="p">+</span> <span class="nv">$CPUCoreCount</span>  
<span class="nv">$CpuCoreTotalCluster</span>

<span class="nv">$CpuCount</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-SCVMHost</span> <span class="n">-ComputerName</span> <span class="nv">$node</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">PhysicalCPUCount</span>  
<span class="nv">$CpuTotalClusterCount</span> <span class="p">=</span> <span class="nv">$CpuTotalClusterCount</span> <span class="p">+</span> <span class="nv">$CpuCount</span>  
<span class="nv">$CpuTotalClusterCount</span>

<span class="p">}</span>  
<span class="c">#$memoryAvailableCluster = ($memoryAvailableCluster \*1024\*1024) /1GB  </span>
<span class="c">#$memoryTotalCluster = ($memoryTotalCluster \*1024\*1024) /1GB  </span>
<span class="nv">$memoryAvailableClusterdisplay</span> <span class="p">=</span> <span class="nv">$memoryAvailableCluster</span> <span class="p">*</span><span class="n">1024</span> <span class="p">*</span><span class="n">1024</span> <span class="p">/</span><span class="n">1GB</span>  
<span class="c">#$memoryAvailableCluster = ($memoryAvailableCluster) /1GB  </span>
<span class="nv">$memoryTotalClusterdisplay</span> <span class="p">=</span> <span class="nv">$memoryTotalCluster</span> <span class="p">*</span><span class="n">1024</span> <span class="p">*</span><span class="n">1024</span> <span class="p">/</span><span class="n">1GB</span>  
<span class="c">#$memoryTotalCluster = ($memoryTotalCluster) /1GB</span>

<span class="nv">$VMTemplate</span> <span class="p">=</span> <span class="nb">Get-SCVMTemplate</span> <span class="n">-Name</span> <span class="s2">&#34;&lt;Name&gt;&#34;</span>

<span class="nv">$TemplateMemory</span> <span class="p">=</span> <span class="nv">$vmtemplate</span><span class="p">.</span><span class="n">Memory</span> <span class="p">*</span> <span class="nv">$numberOfVMS</span>

<span class="nv">$TemplateCPU</span> <span class="p">=</span> <span class="nv">$vmtemplate</span><span class="p">.</span><span class="n">CPUCount</span> <span class="p">*</span> <span class="nv">$numberOfVMS</span>

<span class="c">#Memory Calculation</span>

<span class="nv">$memoryAvailbleAfterVm</span> <span class="p">=</span> <span class="nv">$memoryAvailableCluster</span> <span class="p">-</span> <span class="nv">$TemplateMemory</span>  
<span class="nv">$memoryAvailbleAfterVmdisplay</span> <span class="p">=</span> <span class="nv">$memoryAvailbleAfterVm</span> <span class="p">*</span><span class="n">1024</span> <span class="p">*</span><span class="n">1024</span> <span class="p">/</span><span class="n">1GB</span>  
<span class="c">#$memoryAvailbleAfterVm = $memoryAvailbleAfterVm /1GB  </span>
<span class="nv">$memoryAvailbleAfterVm</span>  
<span class="nv">$memoryAvailbleAfterVmdisplay</span>  
<span class="c">#$memoryAvailbleAfterVm = $memoryAvailbleAfterVm.tostring() + &#34;;GB&#34;; </span>

<span class="nv">$Storage</span> <span class="p">=</span> <span class="p">(</span><span class="nb">get-scvmhostcluster</span> <span class="nv">$VMCluster</span><span class="p">).</span><span class="n">SharedVolumes</span>  
<span class="nv">$StorageCapacity</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$Storage</span> <span class="p">|</span> <span class="nb">Measure-Object</span> <span class="n">-Property</span> <span class="n">Capacity</span> <span class="n">-Sum</span><span class="p">).</span><span class="n">sum</span>  
<span class="nv">$StorageFreeSpace</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$Storage</span> <span class="p">|</span> <span class="nb">Measure-Object</span> <span class="n">-Property</span> <span class="n">FreeSpace</span> <span class="n">-Sum</span><span class="p">).</span><span class="n">sum</span>  
<span class="nv">$StorageUsed</span> <span class="p">=</span> <span class="nv">$StorageCapacity</span> <span class="p">-</span> <span class="nv">$StorageFreeSpace</span>

<span class="nv">$VMVHDUsedSpace</span> <span class="p">=</span> <span class="nv">$VMTemplate</span><span class="p">.</span><span class="n">TotalVHDCapacity</span> <span class="p">*</span> <span class="nv">$numberOfVMS</span>  
<span class="nv">$freeSpaceAfterVMS</span> <span class="p">=</span> <span class="nv">$StorageFreeSpace</span> <span class="p">-</span> <span class="nv">$VMVHDUsedSpace</span>

<span class="c">#=============================================  </span>
</code></pre></div><p>So, I have been using bits and pieces of Orchestrator to string these activities together. However the real power comes in now after using all the pieces from other steps to now, the ACTUAL Deployment. For the sake of simplicity, I am attaching a screenshot of the runbook. Please feel free to contact me (details below) should you want any additional information.</p>
<p>Most of the PowerShell within the Runbook is as a result of unique constraints within this environment, and most cannot be shared. However, like I said, should you want specifics, feel free to contact me and will provide what I can.</p>
<p>The runbook is attached as well, please use at your own discretion, PROVIDED AS IS. <a href="https://github.com/fskelly/hugo-extend-blog-storageAccount/blob/main/externalFiles/2014/07/31/deployvmrunbook.ois_export">DeployVMRunbook</a></p>
<p>Follow me,</p>
<p><a href="https://www.twitter.com/fskelly">Twitter</a><br>
<a href="https://linkedin.com/in/fletcherkelly">LinkedIn</a></p>

        </div>
        <div class="mb-3 post-meta">
           <a href="/tags/grey-agent">#Grey Agent</a>,   <a href="/tags/itsm">#ITSM</a>,   <a href="/tags/runbook">#Runbook</a>,   <a href="/tags/sco">#SCO</a>,  
        </div>
      </div>
      <div class="col-lg-8 mx-auto block shadow">
        
        
        <h3>See Also</h3>
        <ul>
          
          <li><a href="/posts/history/2013-02-04-recover-system-center-orchestrator-2012-with-runbooks-export/">Recover System Center Orchestrator 2012 with runbooks export</a></li>
          
          <li><a href="/2012/06/13/installing-system-centre-orchestrator/">Installing System Centre Orchestrator</a></li>
          
        </ul>
        
      </div>
      
      <div class="col-lg-8 mx-auto block shadow">
        
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "fletchercloudadventures" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </div>
  </div>
</section>


<footer class="py-4 bg-light border-top">
  <div class="container">
    <div class="row justify-content-between align-items-center">
      <div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0">
        <a href="https://flkellyneucloudblogpre.z16.web.core.windows.net/" class="d-block pb-3"><img src="/images/logo.svg" class="img-fluid" alt="Fletcher Kelly | Cloud Engineer"></a>
      </div>
      <div class="col-lg-4 text-center mb-4 mb-lg-0">
        <ul class="list-inline mb-0">
          
        </ul>
      </div>
      <div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0">
        <ul class="list-inline social-icon mb-0">
          
          <li class="list-inline-item"><a href="https://www.twitter.com/fskelly"><i class="ti-twitter-alt"></i></a></li>
          
          <li class="list-inline-item"><a href="https://www.github.com/fskelly"><i class="ti-github"></i></a></li>
          
          <li class="list-inline-item"><a href="https://www.linkedin.com/in/fletcherkelly"><i class="ti-linkedin"></i></a></li>
          
        </ul>
      </div>
    </div>
    <div class="text-center mt-4">
      <span>© 2013 - 2021 Fletcher Kelly All Rights Reserved</span>
    </div>
  </div>
</footer>




<script>
  var indexURL = "https://flkellyneucloudblogpre.z16.web.core.windows.net/index.json"
</script>


<!-- JS Plugins -->

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/jQuery/jquery.min.js"></script>

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/search/fuse.min.js"></script>

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/search/mark.js"></script>

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/search/search.js"></script>


<!-- Main Script -->

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/js/script.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-outline-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>

</body>

</html>