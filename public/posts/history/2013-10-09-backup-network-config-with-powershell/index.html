<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>Backup Network Configuration with PowerShell</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description"
    content="This is meta description">
    
    
  <meta name="author" content="Themefisher">
  <meta name="generator" content="Hugo 0.89.1" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/themify-icons/themify-icons.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/images/favicon.png " type="image/x-icon">

  
  
  



<style type="text/css" media="screen">
  @media (prefers-color-scheme: dark) { 
    /* Background */ .chroma { color: #f8f8f2; background-color: #272822 }
/* Other */ .chroma .x {  }
/* Error */ .chroma .err { color: #960050; background-color: #1e0010 }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
/* Keyword */ .chroma .k { color: #66d9ef }
/* KeywordConstant */ .chroma .kc { color: #66d9ef }
/* KeywordDeclaration */ .chroma .kd { color: #66d9ef }
/* KeywordNamespace */ .chroma .kn { color: #f92672 }
/* KeywordPseudo */ .chroma .kp { color: #66d9ef }
/* KeywordReserved */ .chroma .kr { color: #66d9ef }
/* KeywordType */ .chroma .kt { color: #66d9ef }
/* Name */ .chroma .n {  }
/* NameAttribute */ .chroma .na { color: #a6e22e }
/* NameBuiltin */ .chroma .nb {  }
/* NameBuiltinPseudo */ .chroma .bp {  }
/* NameClass */ .chroma .nc { color: #a6e22e }
/* NameConstant */ .chroma .no { color: #66d9ef }
/* NameDecorator */ .chroma .nd { color: #a6e22e }
/* NameEntity */ .chroma .ni {  }
/* NameException */ .chroma .ne { color: #a6e22e }
/* NameFunction */ .chroma .nf { color: #a6e22e }
/* NameFunctionMagic */ .chroma .fm {  }
/* NameLabel */ .chroma .nl {  }
/* NameNamespace */ .chroma .nn {  }
/* NameOther */ .chroma .nx { color: #a6e22e }
/* NameProperty */ .chroma .py {  }
/* NameTag */ .chroma .nt { color: #f92672 }
/* NameVariable */ .chroma .nv {  }
/* NameVariableClass */ .chroma .vc {  }
/* NameVariableGlobal */ .chroma .vg {  }
/* NameVariableInstance */ .chroma .vi {  }
/* NameVariableMagic */ .chroma .vm {  }
/* Literal */ .chroma .l { color: #ae81ff }
/* LiteralDate */ .chroma .ld { color: #e6db74 }
/* LiteralString */ .chroma .s { color: #e6db74 }
/* LiteralStringAffix */ .chroma .sa { color: #e6db74 }
/* LiteralStringBacktick */ .chroma .sb { color: #e6db74 }
/* LiteralStringChar */ .chroma .sc { color: #e6db74 }
/* LiteralStringDelimiter */ .chroma .dl { color: #e6db74 }
/* LiteralStringDoc */ .chroma .sd { color: #e6db74 }
/* LiteralStringDouble */ .chroma .s2 { color: #e6db74 }
/* LiteralStringEscape */ .chroma .se { color: #ae81ff }
/* LiteralStringHeredoc */ .chroma .sh { color: #e6db74 }
/* LiteralStringInterpol */ .chroma .si { color: #e6db74 }
/* LiteralStringOther */ .chroma .sx { color: #e6db74 }
/* LiteralStringRegex */ .chroma .sr { color: #e6db74 }
/* LiteralStringSingle */ .chroma .s1 { color: #e6db74 }
/* LiteralStringSymbol */ .chroma .ss { color: #e6db74 }
/* LiteralNumber */ .chroma .m { color: #ae81ff }
/* LiteralNumberBin */ .chroma .mb { color: #ae81ff }
/* LiteralNumberFloat */ .chroma .mf { color: #ae81ff }
/* LiteralNumberHex */ .chroma .mh { color: #ae81ff }
/* LiteralNumberInteger */ .chroma .mi { color: #ae81ff }
/* LiteralNumberIntegerLong */ .chroma .il { color: #ae81ff }
/* LiteralNumberOct */ .chroma .mo { color: #ae81ff }
/* Operator */ .chroma .o { color: #f92672 }
/* OperatorWord */ .chroma .ow { color: #f92672 }
/* Punctuation */ .chroma .p {  }
/* Comment */ .chroma .c { color: #75715e }
/* CommentHashbang */ .chroma .ch { color: #75715e }
/* CommentMultiline */ .chroma .cm { color: #75715e }
/* CommentSingle */ .chroma .c1 { color: #75715e }
/* CommentSpecial */ .chroma .cs { color: #75715e }
/* CommentPreproc */ .chroma .cp { color: #75715e }
/* CommentPreprocFile */ .chroma .cpf { color: #75715e }
/* Generic */ .chroma .g {  }
/* GenericDeleted */ .chroma .gd { color: #f92672 }
/* GenericEmph */ .chroma .ge { font-style: italic }
/* GenericError */ .chroma .gr {  }
/* GenericHeading */ .chroma .gh {  }
/* GenericInserted */ .chroma .gi { color: #a6e22e }
/* GenericOutput */ .chroma .go {  }
/* GenericPrompt */ .chroma .gp {  }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #75715e }
/* GenericTraceback */ .chroma .gt {  }
/* GenericUnderline */ .chroma .gl {  }
/* TextWhitespace */ .chroma .w {  }

  }
  @media (prefers-color-scheme: light) { 
    /* Background */ .chroma { background-color: #f8f8f8 }
/* Other */ .chroma .x {  }
/* Error */ .chroma .err {  }
/* LineTableTD */ .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
/* LineTable */ .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
/* LineHighlight */ .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
/* LineNumbersTable */ .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
/* LineNumbers */ .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
/* Keyword */ .chroma .k { color: #aa22ff; font-weight: bold }
/* KeywordConstant */ .chroma .kc { color: #aa22ff; font-weight: bold }
/* KeywordDeclaration */ .chroma .kd { color: #aa22ff; font-weight: bold }
/* KeywordNamespace */ .chroma .kn { color: #aa22ff; font-weight: bold }
/* KeywordPseudo */ .chroma .kp { color: #aa22ff }
/* KeywordReserved */ .chroma .kr { color: #aa22ff; font-weight: bold }
/* KeywordType */ .chroma .kt { color: #00bb00; font-weight: bold }
/* Name */ .chroma .n {  }
/* NameAttribute */ .chroma .na { color: #bb4444 }
/* NameBuiltin */ .chroma .nb { color: #aa22ff }
/* NameBuiltinPseudo */ .chroma .bp {  }
/* NameClass */ .chroma .nc { color: #0000ff }
/* NameConstant */ .chroma .no { color: #880000 }
/* NameDecorator */ .chroma .nd { color: #aa22ff }
/* NameEntity */ .chroma .ni { color: #999999; font-weight: bold }
/* NameException */ .chroma .ne { color: #d2413a; font-weight: bold }
/* NameFunction */ .chroma .nf { color: #00a000 }
/* NameFunctionMagic */ .chroma .fm {  }
/* NameLabel */ .chroma .nl { color: #a0a000 }
/* NameNamespace */ .chroma .nn { color: #0000ff; font-weight: bold }
/* NameOther */ .chroma .nx {  }
/* NameProperty */ .chroma .py {  }
/* NameTag */ .chroma .nt { color: #008000; font-weight: bold }
/* NameVariable */ .chroma .nv { color: #b8860b }
/* NameVariableClass */ .chroma .vc {  }
/* NameVariableGlobal */ .chroma .vg {  }
/* NameVariableInstance */ .chroma .vi {  }
/* NameVariableMagic */ .chroma .vm {  }
/* Literal */ .chroma .l {  }
/* LiteralDate */ .chroma .ld {  }
/* LiteralString */ .chroma .s { color: #bb4444 }
/* LiteralStringAffix */ .chroma .sa { color: #bb4444 }
/* LiteralStringBacktick */ .chroma .sb { color: #bb4444 }
/* LiteralStringChar */ .chroma .sc { color: #bb4444 }
/* LiteralStringDelimiter */ .chroma .dl { color: #bb4444 }
/* LiteralStringDoc */ .chroma .sd { color: #bb4444; font-style: italic }
/* LiteralStringDouble */ .chroma .s2 { color: #bb4444 }
/* LiteralStringEscape */ .chroma .se { color: #bb6622; font-weight: bold }
/* LiteralStringHeredoc */ .chroma .sh { color: #bb4444 }
/* LiteralStringInterpol */ .chroma .si { color: #bb6688; font-weight: bold }
/* LiteralStringOther */ .chroma .sx { color: #008000 }
/* LiteralStringRegex */ .chroma .sr { color: #bb6688 }
/* LiteralStringSingle */ .chroma .s1 { color: #bb4444 }
/* LiteralStringSymbol */ .chroma .ss { color: #b8860b }
/* LiteralNumber */ .chroma .m { color: #666666 }
/* LiteralNumberBin */ .chroma .mb { color: #666666 }
/* LiteralNumberFloat */ .chroma .mf { color: #666666 }
/* LiteralNumberHex */ .chroma .mh { color: #666666 }
/* LiteralNumberInteger */ .chroma .mi { color: #666666 }
/* LiteralNumberIntegerLong */ .chroma .il { color: #666666 }
/* LiteralNumberOct */ .chroma .mo { color: #666666 }
/* Operator */ .chroma .o { color: #666666 }
/* OperatorWord */ .chroma .ow { color: #aa22ff; font-weight: bold }
/* Punctuation */ .chroma .p {  }
/* Comment */ .chroma .c { color: #008800; font-style: italic }
/* CommentHashbang */ .chroma .ch { color: #008800; font-style: italic }
/* CommentMultiline */ .chroma .cm { color: #008800; font-style: italic }
/* CommentSingle */ .chroma .c1 { color: #008800; font-style: italic }
/* CommentSpecial */ .chroma .cs { color: #008800; font-weight: bold }
/* CommentPreproc */ .chroma .cp { color: #008800 }
/* CommentPreprocFile */ .chroma .cpf { color: #008800 }
/* Generic */ .chroma .g {  }
/* GenericDeleted */ .chroma .gd { color: #a00000 }
/* GenericEmph */ .chroma .ge { font-style: italic }
/* GenericError */ .chroma .gr { color: #ff0000 }
/* GenericHeading */ .chroma .gh { color: #000080; font-weight: bold }
/* GenericInserted */ .chroma .gi { color: #00a000 }
/* GenericOutput */ .chroma .go { color: #888888 }
/* GenericPrompt */ .chroma .gp { color: #000080; font-weight: bold }
/* GenericStrong */ .chroma .gs { font-weight: bold }
/* GenericSubheading */ .chroma .gu { color: #800080; font-weight: bold }
/* GenericTraceback */ .chroma .gt { color: #0044dd }
/* GenericUnderline */ .chroma .gl { text-decoration: underline }
/* TextWhitespace */ .chroma .w { color: #bbbbbb }
 
  }
  </style>

</head><body>
    
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="fixed-top navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-light bg-transparent">
      <a class="navbar-brand"href="https://flkellyneucloudblogpre.z16.web.core.windows.net/"><img class="img-fluid" src="/images/logo.svg" alt="Fletcher Kelly | Cloud Engineer"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="https://flkellyneucloudblogpre.z16.web.core.windows.net/"> Home </a>
          </li>
          
        </ul>
        
        <!-- search -->
        <div class="search">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://flkellyneucloudblogpre.z16.web.core.windows.net/search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation --> <div class="py-5 d-none d-lg-block"></div> 

<section class="section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto block shadow mb-5">
        <h2>Backup Network Configuration with PowerShell</h2>
        <div class="mb-3 post-meta">
          <a href="/author/fletcher-kelly">Fletcher Kelly</a>,
          Oct 9, 2013, 
          <a href="/categories/powershell">PowerShell</a>
          
        </div>
        
        <div class="content mb-5">
          <!-- raw HTML omitted -->
<p>So, one of the consultants in the company I work at came to me with a strange request.</p>
<p>The request from the customer he was helping was the following. They wanted a way to connect to all the switches within their environment and then run some commands against the switch after connecting to the switch on port 23. Once the connection has been made, then some commands are run to get the current running configuration. Then export this to a text file.</p>
<p>So I found a basic script <a href="https://brianreiter.org/2011/06/08/cool-powershell-script-replicates-telnet/">here</a> and copy of <a href="https://github.com/fskelly/hugo-extend-blog-storageAccount/blob/main/externalFiles/2013/10/09/CoolPowerShellScriptReplicatesTelnet.ps1">script</a>. I have since taken this and modified and extended the script. I have added an array for the IPs to be checked. I have also added some checking prior to running any commands. I have added some testing.</p>
<p>First, we test the connection and see if the device is responding to pings. If the device is responding to pings, then test and see if the device is configured for telnet. So basically I am looking to see if port 23 is open. If port 23 is not opened, a log file is updated with the IP Address. If the device is not responding to pings, a log file is updated stating the IP of the &ldquo;non-responding&rdquo; device.</p>
<p>As an addition to the script, the files are then added to an e-mail which is sent to whomever you want to add. As part of the email process, a check is done and if an error is thrown, there is more information presented in the console to point you in the correct direction.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># PowerShell: Script To Telnet To Remote Hosts And Run Commands Against Them With Output To A File ##  </span>
<span class="c"># Overview: Useful for Telnet connections to Cisco Switches and other devices. Can add additional command strings  </span>
<span class="c"># Usage Examples: Add your environment specific details into the parameters below, or include when calling the script:  </span>
<span class="c"># ./PowerShellTelnetRemoteSession.ps1 &#34;127.0.0.1&#34; &#34;23&#34; &#34;admin&#34; &#34;password&#34; &#34;term len 0&#34; &#34;en&#34; &#34;enablepassword&#34; &#34;show interface&#34;</span>

<span class="k">param</span><span class="p">(</span>  
<span class="c">#[string] $remoteHost = &#34;172.31.0.111&#34;,  </span>
<span class="c">#[int] $port = 23,  </span>
<span class="no">[string]</span> <span class="nv">$username</span> <span class="p">=</span> <span class="s2">&#34;admin&#34;</span><span class="p">,</span>  
<span class="no">[string]</span> <span class="nv">$password</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>  
<span class="c">#[string] $termlength = &#34;term len 0&#34;, #Useful for older consoles that have line display limitations  </span>
<span class="no">[string]</span> <span class="nv">$enable</span> <span class="p">=</span> <span class="s2">&#34;en&#34;</span><span class="p">,</span> <span class="c">#Useful for appliances like Cisco switches that have an &amp;#8216;enable&amp;#8217; command mode  </span>
<span class="no">[string]</span> <span class="nv">$enablepassword</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>  
<span class="no">[string]</span> <span class="nv">$command1</span> <span class="p">=</span> <span class="s2">&#34;show run&#34;</span><span class="p">,</span> <span class="c">#You can add additional commands below here with additonal strings if you want  </span>
<span class="no">[string]</span> <span class="nv">$command2</span> <span class="p">=</span> <span class="s2">&#34; &#34;</span><span class="p">,</span>  
<span class="no">[string]</span> <span class="nv">$command3</span> <span class="p">=</span> <span class="s2">&#34; &#34;</span><span class="p">,</span>  
<span class="no">[string]</span> <span class="nv">$command4</span> <span class="p">=</span> <span class="s2">&#34; &#34;</span><span class="p">,</span>  
<span class="no">[string]</span> <span class="nv">$command5</span> <span class="p">=</span> <span class="s2">&#34; &#34;</span><span class="p">,</span>  
<span class="no">[int]</span> <span class="nv">$commandDelay</span> <span class="p">=</span> <span class="n">1000</span>  
<span class="p">)</span>
<span class="no">[string]</span> <span class="nv">$output</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
<span class="c"># Read output from a remote host  </span>
<span class="k">function</span> <span class="n">GetOutput</span>  
<span class="p">{</span>  
<span class="c"># Create a buffer to receive the response  </span>
<span class="nv">$buffer</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Byte</span><span class="p">[]</span> <span class="n">4096</span>  
<span class="nv">$encoding</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">AsciiEncoding</span>
<span class="nv">$outputBuffer</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>  
<span class="nv">$foundMore</span> <span class="p">=</span> <span class="nv">$false</span>

<span class="c"># Read all the data available from the stream, writing it to the  </span>
<span class="c"># output buffer when done.  </span>
<span class="k">do</span>  
<span class="p">{</span>  
<span class="c"># Allow data to buffer for a bit  </span>
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="n">1000</span>

<span class="c"># Read what data is available  </span>
<span class="nv">$foundmore</span> <span class="p">=</span> <span class="nv">$false</span>  
<span class="nv">$stream</span><span class="p">.</span><span class="n">ReadTimeout</span> <span class="p">=</span> <span class="n">1000</span>

<span class="k">do</span>  
<span class="p">{</span>  
  <span class="k">try</span>  
  <span class="p">{</span>      
    <span class="nv">$read</span> <span class="p">=</span> <span class="nv">$stream</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="n">1024</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$read</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">)</span>  
    <span class="p">{</span>  
        <span class="nv">$foundmore</span> <span class="p">=</span> <span class="nv">$true</span>  
        <span class="nv">$outputBuffer</span> <span class="p">+=</span> <span class="p">(</span><span class="nv">$encoding</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$read</span><span class="p">))</span>  
    <span class="p">}</span>          
  <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span> <span class="nv">$foundMore</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">;</span> <span class="nv">$read</span> <span class="p">=</span> <span class="n">0</span> <span class="p">}</span>  
  <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nv">$read</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">)</span>  
<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nv">$foundmore</span><span class="p">)</span>

<span class="nv">$outputBuffer</span>  
<span class="p">}</span>

<span class="k">function</span> <span class="n">Main</span>  
<span class="p">{</span>  
<span class="k">param</span> <span class="p">(</span><span class="nv">$ip</span><span class="p">,</span><span class="nv">$port</span><span class="p">)</span>  
<span class="c">## Open the socket, and connect to the computer on the specified port</span>
<span class="nb">Write-Host</span> <span class="s2">&#34;Connecting to $ip on port $port&#34;</span>
<span class="nv">$socket</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">Sockets</span><span class="p">.</span><span class="n">TcpClient</span><span class="p">(</span><span class="nv">$ip</span><span class="p">,</span> <span class="nv">$port</span><span class="p">)</span>
<span class="nb">Write-Host</span> <span class="s2">&#34;Connected. Press ^D followed by [ENTER] to exit.\</span><span class="se">`n</span><span class="s2">&#34;</span>
<span class="nv">$stream</span> <span class="p">=</span> <span class="nv">$socket</span><span class="p">.</span><span class="n">GetStream</span><span class="p">()</span>
<span class="nv">$writer</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">StreamWriter</span> <span class="nv">$stream</span>

<span class="c">## Receive the output that has buffered so far  </span>
<span class="nv">$SCRIPT:output</span> <span class="p">+=</span> <span class="n">GetOutput</span>
<span class="nv">$writer</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="nv">$username</span><span class="p">)</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">()</span>  
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="nv">$commandDelay</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">()</span>  
<span class="c">#Start-Sleep -m $commandDelay  </span>
<span class="c">#$writer.WriteLine($termlength)  </span>
<span class="c">#$writer.Flush()  </span>
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="nv">$commandDelay</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="nv">$enable</span><span class="p">)</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">()</span>  
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="nv">$commandDelay</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="nv">$enablepassword</span><span class="p">)</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">()</span>  
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="nv">$commandDelay</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="nv">$command1</span><span class="p">)</span> <span class="c">#Add additional entries below here for additional &amp;#8216;strings&amp;#8217; you created above  </span>
<span class="nv">$writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">()</span>  
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="nv">$commandDelay</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="nv">$command2</span><span class="p">)</span> <span class="c">#Add additional entries below here for additional &amp;#8216;strings&amp;#8217; you created above  </span>
<span class="nv">$writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">()</span>  
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="nv">$commandDelay</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="nv">$command3</span><span class="p">)</span> <span class="c">#Add additional entries below here for additional &amp;#8216;strings&amp;#8217; you created above  </span>
<span class="nv">$writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">()</span>  
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="nv">$commandDelay</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="nv">$command4</span><span class="p">)</span> <span class="c">#Add additional entries below here for additional &amp;#8216;strings&amp;#8217; you created above  </span>
<span class="nv">$writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">()</span>  
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="nv">$commandDelay</span>  
<span class="nv">$writer</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="nv">$command5</span><span class="p">)</span> <span class="c">#Add additional entries below here for additional &amp;#8216;strings&amp;#8217; you created above  </span>
<span class="nv">$writer</span><span class="p">.</span><span class="n">Flush</span><span class="p">()</span>  
<span class="nb">Start-Sleep</span> <span class="n">-m</span> <span class="nv">$commandDelay</span>  
<span class="nv">$SCRIPT:output</span> <span class="p">+=</span> <span class="n">GetOutput</span>

<span class="c"># Close the streams  </span>
<span class="nv">$writer</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>  
<span class="nv">$stream</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="c">#building file name  </span>
<span class="nv">$filename</span> <span class="p">=</span> <span class="s2">&#34;c:\switch\$ip - &#34;</span> <span class="p">+</span> <span class="nv">$timestamp</span> <span class="p">+</span> <span class="s2">&#34;.txt&#34;</span>

<span class="nv">$output</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="nv">$filename</span> <span class="c">#Change this to suit your environment  </span>
<span class="p">}</span>

<span class="c">#build the list of ips to be queried  </span>
<span class="nv">$ips</span> <span class="p">=</span> <span class="s2">&#34;192.168.1.2&#34;</span><span class="p">,</span><span class="s2">&#34;169.254.2.2&#34;</span><span class="p">,</span><span class="s2">&#34;192.168.1.101&#34;</span>

<span class="c">#building a file path  </span>
<span class="nv">$timestamp</span> <span class="p">=</span> <span class="nb">get-date</span> <span class="n">-Format</span> <span class="n">g</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{</span><span class="nv">$_</span> <span class="o">-replace</span> <span class="s2">&#34;:&#34;</span><span class="p">,</span><span class="s2">&#34;.&#34;</span><span class="p">}</span>

<span class="c">#building different file paths for different functions  </span>
<span class="nv">$errortimestamp</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="n">o</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{</span><span class="nv">$_</span> <span class="o">-replace</span> <span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;.&#34;</span><span class="p">}</span>  
<span class="nv">$errorfilename</span> <span class="p">=</span> <span class="s2">&#34;c:\switch\&#34;</span> <span class="p">+</span> <span class="nv">$timestamp</span> <span class="p">+</span> <span class="s2">&#34; - ERROR.txt&#34;</span>

<span class="c">#building different file paths for different functions  </span>
<span class="nv">$blockedtimestamp</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="n">o</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{</span><span class="nv">$_</span> <span class="o">-replace</span> <span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;.&#34;</span><span class="p">}</span>  
<span class="nv">$blockedfilename</span> <span class="p">=</span> <span class="s2">&#34;c:\switch\&#34;</span> <span class="p">+</span> <span class="nv">$timestamp</span> <span class="p">+</span> <span class="s2">&#34; - blocked.txt&#34;</span>

<span class="c">#looping through each ip in ip list  </span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$ip</span> <span class="k">in</span> <span class="nv">$ips</span><span class="p">)</span>  
<span class="p">{</span>  
<span class="nb">Write-host</span> <span class="s2">&#34;Testing $ip&#34;</span>  
<span class="c">#test to see if device is responding to pings  </span>
<span class="k">if</span> <span class="p">(</span><span class="nb">Test-Connection</span> <span class="nv">$ip</span> <span class="n">-Quiet</span><span class="p">)</span>  
<span class="p">{</span>  
<span class="c">#creating connection on port 23  </span>
<span class="nv">$t</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Net</span><span class="p">.</span><span class="n">Sockets</span><span class="p">.</span><span class="n">TcpClient</span>  
<span class="nv">$t</span><span class="p">.</span><span class="n">Connect</span><span class="p">(</span><span class="nv">$ip</span><span class="p">,</span> <span class="n">23</span><span class="p">)</span>

<span class="c">#if it connects, runs the required function with the ip  </span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$t</span><span class="p">.</span><span class="n">Connected</span><span class="p">)</span>  
<span class="p">{</span>  
<span class="p">.</span> <span class="n">Main</span> <span class="nv">$ip</span> <span class="s2">&#34;23&#34;</span>  
<span class="p">}</span>  
<span class="c">#script block for device responding to ping, but port 23 is NOT open  </span>
<span class="k">else</span>  
<span class="p">{</span>  
<span class="nv">$portblocked</span> <span class="p">=</span> <span class="s2">&#34;Port 23 on $ip is closed , You may need to contact your IT team to open it. &#34;</span>  
<span class="nb">Add-Content</span> <span class="nv">$blockedfilename</span> <span class="s2">&#34;\</span><span class="se">`n</span><span class="s2">$portblocked&#34;</span>  
<span class="p">}</span>  
<span class="p">}</span>  
<span class="c">#script block for NO RESPONSE  </span>
<span class="k">else</span>  
<span class="p">{</span>  
<span class="nv">$errorfilename</span> <span class="p">=</span> <span class="s2">&#34;c:\switch\&#34;</span> <span class="p">+</span> <span class="nv">$timestamp</span> <span class="p">+</span> <span class="s2">&#34; - ERROR.txt&#34;</span>  
<span class="nb">Add-Content</span> <span class="nv">$errorfilename</span> <span class="s2">&#34;\</span><span class="se">`n</span><span class="s2">Could not ping $ip&#34;</span>  
<span class="p">}</span>  
<span class="p">}</span>

<span class="c">#displaying information on console  </span>
<span class="nb">Write-Host</span> <span class="s2">&#34;Build file list&#34;</span> <span class="n">-NoNewline</span>  
<span class="c">#getting file list to be emailed  </span>
<span class="nv">$files</span> <span class="p">=</span> <span class="nb">Get-ChildItem</span> <span class="n">C:</span><span class="p">\</span><span class="k">Switch</span><span class="p">\</span> <span class="p">|</span> <span class="nb">Where </span><span class="p">{</span><span class="o">-NOT</span> <span class="p">$\</span><span class="n">_</span><span class="p">.</span><span class="n">PSIsContainer</span><span class="p">}</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{$\</span><span class="n">_</span><span class="p">.</span><span class="n">fullname</span><span class="p">}</span>  
<span class="c">#pausing script  </span>
<span class="nb">Start-Sleep</span> <span class="n">3</span>  
<span class="nb">Write-Host</span> <span class="s2">&#34;\</span><span class="se">`t</span><span class="s2">&#34;</span> <span class="no">[File List Built]</span> <span class="n">-ForegroundColor</span> <span class="s2">&#34;Green&#34;</span>

<span class="nb">Write-Host</span> <span class="s2">&#34;Sending Email&#34;</span> <span class="n">-NoNewline</span>

<span class="c">#building checks for sending emails</span>

<span class="c">#no error</span>

<span class="c">#replace as needed  </span>
<span class="nv">$to</span> <span class="p">=</span> <span class="s2">&#34;&lt;to&gt;&#34;</span>  
<span class="nv">$from</span> <span class="p">=</span> <span class="s2">&#34;&lt;from&gt;&#34;</span>  
<span class="nv">$smtpserver</span> <span class="p">=</span> <span class="s2">&#34;&lt;smtpserver&gt;&#34;</span>

<span class="k">try</span>  
<span class="p">{</span>  
<span class="nb">Send-MailMessage</span> <span class="n">-Attachments</span> <span class="nv">$files</span> <span class="n">-to</span> <span class="nv">$to</span> <span class="n">-from</span> <span class="nv">$from</span> <span class="n">-Subject</span> <span class="s2">&#34;Network Config backup - $timestamp&#34;</span> <span class="n">-SmtpServer</span> <span class="nv">$smtpserver</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>  
<span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`t</span><span class="s2"> [Email Sent]&#34;</span> <span class="n">-ForegroundColor</span> <span class="s2">&#34;Green&#34;</span>  
<span class="p">}</span>  
<span class="c">#error  </span>
<span class="k">catch</span>  
<span class="p">{</span>  
<span class="nv">$ErrorMessage</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span>  
<span class="c">#$ErrorMessage  </span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$ErrorMessage</span> <span class="o">-ne</span> <span class="nv">$null</span><span class="p">)</span>  
<span class="p">{</span>  
<span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`t</span><span class="s2"> [Unable to send Mail]&#34;</span> <span class="n">-ForegroundColor</span> <span class="s2">&#34;Red&#34;</span>  
<span class="nb">Write-Host</span> <span class="s2">&#34;There was an error: $ErrorMessage&#34;</span> <span class="n">-ForegroundColor</span> <span class="s2">&#34;Yellow&#34;</span>  
<span class="p">}</span>  
<span class="p">}</span>

<span class="nb">Start-Sleep</span> <span class="n">3</span>  
<span class="nb">Write-Host</span> <span class="s2">&#34;Removing Files&#34;</span> <span class="n">-NoNewline</span>  
<span class="nv">$files</span> <span class="p">|</span> <span class="nb">Remove-Item</span>  
<span class="nb">Write-Host</span> <span class="s2">&#34;</span><span class="se">`t</span><span class="s2"> [Files removed]&#34;</span> <span class="n">-ForegroundColor</span> <span class="s2">&#34;Green&#34;</span>

</code></pre></div><p>Follow me,</p>
<p><a href="https://www.twitter.com/fskelly">Twitter</a><br>
<a href="https://linkedin.com/in/fletcherkelly">LinkedIn</a></p>

        </div>
        <div class="mb-3 post-meta">
           <a href="/tags/powershell">#PowerShell</a>,   <a href="/tags/scripting">#Scripting</a>,  
        </div>
      </div>
      <div class="col-lg-8 mx-auto block shadow">
        
        
        <h3>See Also</h3>
        <ul>
          
          <li><a href="/posts/history/2013-09-11-service-request-load-testing-for-scsm/">Service Request Load Testing for SCSM</a></li>
          
          <li><a href="/posts/history/2012-12-20-assignedto-and-affecteduser-with-powershell-service-manager/">AssignedTo and AffectedUser with Powershell – Service Manager</a></li>
          
        </ul>
        
      </div>
      
      <div class="col-lg-8 mx-auto block shadow">
        
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "fletchercloudadventures" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      
    </div>
  </div>
</section>


<footer class="py-4 bg-light border-top">
  <div class="container">
    <div class="row justify-content-between align-items-center">
      <div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0">
        <a href="https://flkellyneucloudblogpre.z16.web.core.windows.net/" class="d-block pb-3"><img src="/images/logo.svg" class="img-fluid" alt="Fletcher Kelly | Cloud Engineer"></a>
      </div>
      <div class="col-lg-4 text-center mb-4 mb-lg-0">
        <ul class="list-inline mb-0">
          
        </ul>
      </div>
      <div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0">
        <ul class="list-inline social-icon mb-0">
          
          <li class="list-inline-item"><a href="https://www.twitter.com/fskelly"><i class="ti-twitter-alt"></i></a></li>
          
          <li class="list-inline-item"><a href="https://www.github.com/fskelly"><i class="ti-github"></i></a></li>
          
          <li class="list-inline-item"><a href="https://www.linkedin.com/in/fletcherkelly"><i class="ti-linkedin"></i></a></li>
          
        </ul>
      </div>
    </div>
    <div class="text-center mt-4">
      <span>© 2013 - 2021 Fletcher Kelly All Rights Reserved</span>
    </div>
  </div>
</footer>




<script>
  var indexURL = "https://flkellyneucloudblogpre.z16.web.core.windows.net/index.json"
</script>


<!-- JS Plugins -->

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/jQuery/jquery.min.js"></script>

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/search/fuse.min.js"></script>

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/search/mark.js"></script>

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/plugins/search/search.js"></script>


<!-- Main Script -->

<script src="https://flkellyneucloudblogpre.z16.web.core.windows.net/js/script.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-outline-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>

</body>

</html>