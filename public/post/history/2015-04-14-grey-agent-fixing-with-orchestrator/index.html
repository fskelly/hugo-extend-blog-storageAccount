<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Grey Agent Fixing with Orchestrator | 
    Fletcher&#39;s Tech Blog
  
</title><meta name="description" content="A day in the life of a Cloud Engineer."><meta name="author" content="Fletcher Kelly">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">


    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css">
    



    
        
            <link rel="stylesheet" href="/dist/main.37ab3f61b95417873748.min.css">
        
    




<link rel="canonical" href="https://cloudadventures.fskelly.com/post/history/2015-04-14-grey-agent-fixing-with-orchestrator/"><meta property="og:title" content="Grey Agent Fixing with Orchestrator" />
<meta property="og:description" content="So, here is the scenario, we managed a lot of customer‚Äôs System Centre Operations Manager (SCOM) environments. One of the most common issues we run into, it is the ‚ÄúGrey Agent‚Äù issue, where an agent is no longer reporting into SCOM. There might be a few reasons for this, however one of the most common and effective ways to fix this to clear the agent cache. By this, we simply mean connecting to the agent, stopping the ‚ÄúSCOM‚Äù service, deleting the content of the ‚ÄúHealth Service State‚Äù folder and then restarting the ‚ÄúSCOM‚Äù service." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cloudadventures.fskelly.com/post/history/2015-04-14-grey-agent-fixing-with-orchestrator/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2015-04-14T05:08:44+00:00" />
<meta property="article:modified_time" content="2015-04-14T05:08:44+00:00" />

<meta itemprop="name" content="Grey Agent Fixing with Orchestrator">
<meta itemprop="description" content="So, here is the scenario, we managed a lot of customer‚Äôs System Centre Operations Manager (SCOM) environments. One of the most common issues we run into, it is the ‚ÄúGrey Agent‚Äù issue, where an agent is no longer reporting into SCOM. There might be a few reasons for this, however one of the most common and effective ways to fix this to clear the agent cache. By this, we simply mean connecting to the agent, stopping the ‚ÄúSCOM‚Äù service, deleting the content of the ‚ÄúHealth Service State‚Äù folder and then restarting the ‚ÄúSCOM‚Äù service."><meta itemprop="datePublished" content="2015-04-14T05:08:44+00:00" />
<meta itemprop="dateModified" content="2015-04-14T05:08:44+00:00" />
<meta itemprop="wordCount" content="349">
<meta itemprop="keywords" content="Grey Agent,Grey Agent Fix,Runbook,SCO," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Grey Agent Fixing with Orchestrator"/>
<meta name="twitter:description" content="So, here is the scenario, we managed a lot of customer‚Äôs System Centre Operations Manager (SCOM) environments. One of the most common issues we run into, it is the ‚ÄúGrey Agent‚Äù issue, where an agent is no longer reporting into SCOM. There might be a few reasons for this, however one of the most common and effective ways to fix this to clear the agent cache. By this, we simply mean connecting to the agent, stopping the ‚ÄúSCOM‚Äù service, deleting the content of the ‚ÄúHealth Service State‚Äù folder and then restarting the ‚ÄúSCOM‚Äù service."/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://cloudadventures.fskelly.com">Fletcher&#39;s Tech Blog</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/about/">About</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/about/">About</a></li>
                
            
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="meta text-muted mb-3">
                            <p class="created text-muted text-uppercase font-weight-bold mb-1">April 14, 2015</p>
                            <span class="mr-2"><i class="fas fa-book-open mr-2"></i>349 words</span>
                            <span><i class="fas fa-clock mr-2"></i>2 mins read</span>
                        </div>

                        <h1>Grey Agent Fixing with Orchestrator</h1>

                        <ul class="authors list-inline"><li class="list-inline-item mr-3">
                    <div class="media author"><a href="/authors/fletcher-kelly/" class="mr-3">
                                    <picture>
                                        <source srcset="/authors/fletcher-kelly/fletcher-kelly_hu1961412ea3fc9229cbd8c0509c2bcf00_39727_64x0_resize_q75_box.jpg 1x, /authors/fletcher-kelly/fletcher-kelly_hu1961412ea3fc9229cbd8c0509c2bcf00_39727_128x0_resize_q100_box.jpg 2x, /authors/fletcher-kelly/fletcher-kelly_hu1961412ea3fc9229cbd8c0509c2bcf00_39727_192x0_resize_q100_box.jpg 3x">
                                        <img src="/authors/fletcher-kelly/fletcher-kelly_hu1961412ea3fc9229cbd8c0509c2bcf00_39727_64x0_resize_q75_box.jpg" class="rounded-circle" alt="Fletcher Kelly">
                                    </picture>
                                </a><div class="media-body">
                            <h5 class="name my-0"><a href="/authors/fletcher-kelly/" class="small">Fletcher Kelly</a>
                            </h5><p class="social small text-muted">
                                    <a href="https://twitter.com/@fskelly">@fskelly</a>
                                </p></div>
                    </div>
                </li></ul>
                    </div>
                </div><div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="content">
                            <!-- raw HTML omitted -->
<p>So, here is the scenario, we managed a lot of customer‚Äôs System Centre Operations Manager (SCOM) environments. One of the most common issues we run into, it is the ‚ÄúGrey Agent‚Äù issue, where an agent is no longer reporting into SCOM. There might be a few reasons for this, however one of the most common and effective ways to fix this to clear the agent cache. By this, we simply mean connecting to the agent, stopping the ‚ÄúSCOM‚Äù service, deleting the content of the ‚ÄúHealth Service State‚Äù folder and then restarting the ‚ÄúSCOM‚Äù service.</p>
<p>Yes, this is a perfect candidate for PowerShell and their a quite a few scripts that do this in numerous ways using PowerShell, I have a <a href="https://github.com/fskelly/hugo-extend-blog-storageAccount/blob/main/externalFiles/2015/04/14/Rebuild-OpsMancache.ps1">script</a> for this, but they are usually dependant upon a list of some and then loop through this, I decided to use my friend, System Centre Orchestrator (SCO) to facilitate this is in a time manner, with more flexibility and log building as well as inputting the results into a database. With SCO, we also have more avenues available to us for error handling, like logging a call within SCSM or ‚Äúricher‚Äù email or the like.</p>
<p>So, I have learnt with SCO, the best thing to do is to actually sit down and whiteboard you solution, simply draw out the steps you want to follow and think of some error handling. With my example, my logic was as follows. I have added a Visio diagram as my handwriting is barely legible even to me üôÇ</p>
<ol>
<li>Query Database for grey agents, there is a SQL Script for this.</li>
<li>Create Folder for logging</li>
<li>Read SQL results into a file for ‚Äú‚Äôlooping‚Äù</li>
<li>DNS Test</li>
<li>Ping Test</li>
<li>Determine Service Name and folder path (Remember we might be dealing with multiple versions of SCOM here</li>
<li>Check Service status, to determine if a stop of the service is needed</li>
<li>Stop if needed</li>
<li>Delete files</li>
<li>Wait 10 Seconds</li>
<li>Start Service</li>
<li>Write log to Database</li>
</ol>
<figure class="figure">
    <a href="/wp-content/uploads/2015/04/scom_greyagentfix_thumb.jpg" class="d-block" data-toggle="lightbox" data-gallery="post-gallery">
        <img src="/wp-content/uploads/2015/04/scom_greyagentfix_thumb.jpg"class="figure-img img-fluid"
        /> 
    </a>
</figure>

<p>The SQL query will be part of the Runbook file, it can be found <a href="https://github.com/fskelly/hugo-extend-blog-storageAccount/blob/main/externalFiles/2015/04/14/scom_greyagentfix.ois_export">here</a>.</p>
<p>Have fun automating.</p>
<p>Follow me,</p>
<p><a href="https://www.twitter.com/fskelly">Twitter</a><br>
<a href="https://linkedin.com/in/fletcherkelly">LinkedIn</a></p>

                        </div><div class="tags my-3"><a class="badge badge-pill badge-light border mr-2" href="/tags/grey-agent">
                                    <i class="fas fa-tag mr-2"></i>Grey Agent
                                </a><a class="badge badge-pill badge-light border mr-2" href="/tags/grey-agent-fix">
                                    <i class="fas fa-tag mr-2"></i>Grey Agent Fix
                                </a><a class="badge badge-pill badge-light border mr-2" href="/tags/runbook">
                                    <i class="fas fa-tag mr-2"></i>Runbook
                                </a><a class="badge badge-pill badge-light border mr-2" href="/tags/sco">
                                    <i class="fas fa-tag mr-2"></i>SCO
                                </a></div><ul class="share nav my-3 justify-content-end">
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fcloudadventures.fskelly.com%2fpost%2fhistory%2f2015-04-14-grey-agent-fixing-with-orchestrator%2f&text=Grey%20Agent%20Fixing%20with%20Orchestrator">
              <i class="fa-fw fab fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fcloudadventures.fskelly.com%2fpost%2fhistory%2f2015-04-14-grey-agent-fixing-with-orchestrator%2f&title=Grey%20Agent%20Fixing%20with%20Orchestrator">
                <i class="fa-fw fab fa-linkedin-in"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fcloudadventures.fskelly.com%2fpost%2fhistory%2f2015-04-14-grey-agent-fixing-with-orchestrator%2f&t=Grey%20Agent%20Fixing%20with%20Orchestrator">
                <i class="fa-fw fab fa-facebook-f"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://reddit.com/submit?url=https%3a%2f%2fcloudadventures.fskelly.com%2fpost%2fhistory%2f2015-04-14-grey-agent-fixing-with-orchestrator%2f&title=Grey%20Agent%20Fixing%20with%20Orchestrator">
                <i class="fa-fw fab fa-reddit-alien"></i>
            </a>
        </li>
    </nav>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        
                    </div>
                </div><div class="row justify-content-center my-3">
                    <div class="col-lg-8">
                        <div id="commento"></div>
                        <script src="https://commento.io"></script>
                    </div>
                </div></article>
        </div>
    </div>

    <div class="related-content row mt-5 row-cols-1 row-cols-lg-3"><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/post/history/2014-07-31-deploy-a-vm-scsm-scvmm-scorch-all-working-in-harmony/" class="d-block"><div class="card-body">
            <h4 class="card-title">Deploy a VM ‚Äì SCSM, SCVMM, SCORCH ‚Äì all working in harmony</h4>
            <p class="card-text text-muted text-uppercase">July 31, 2014</p>
            <div class="card-text">
                So, it has been a while.
So, the requirement for this project was as follow.
 Use Service Manager. Provide a portal for logging a VM Creation request. Build the computername based on a predetermined pattern. Determine first available name. Perform a capacity check. Deploy the set number of VMs.  I am going to skip over the first 2 Points, there are numerous topics covering this. So, onto point 3, I created a Service Request Extension, if anyone would like some info on this, also plenty of articles, please let me know and I can do a blog post on the Extension, or I can make the extension available for you to seal yourselves.
            </div>
        </div>
    </a>
</div>

            </div><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/2013/08/05/end-user-portal-for-system-centre-orchestrator/" class="d-block"><div class="card-body">
            <h4 class="card-title">End User Portal for System Centre Orchestrator</h4>
            <p class="card-text text-muted text-uppercase">August 5, 2013</p>
            <div class="card-text">
                So, let‚Äôs ay you have invested the time and gotten System Centre Orchestrator up and running in your environment and you have the product performing some day to day tasks and it is working well. However, now you want start using SCO (System Centre Orchestrator) to start performing end user focused tasks like Password Reset, add users to groups or even disabling of users or server testing as part of first line support.
            </div>
        </div>
    </a>
</div>

            </div><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/2013/02/04/recover-system-center-orchestrator-2012-with-runbooks-export/" class="d-block"><div class="card-body">
            <h4 class="card-title">Recover System Center Orchestrator 2012 with runbooks export</h4>
            <p class="card-text text-muted text-uppercase">February 4, 2013</p>
            <div class="card-text">
                Just recently in a test environment, a script or some such other gremlin caused some absolute havoc on my system. Before you ask, I had NO Backup in place of this system. This system was System Center Orchestrator. However, once a week, I do a ‚Äúsort-of‚Äù backup. By this, I mean I export all my Runbooks and place a copy on my local machine and a file server and the SCORCH (System Center ORCHestrator) server.
            </div>
        </div>
    </a>
</div>

            </div></div>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    <li class="list-inline-item"><a href="https://cloudadventures.fskelly.com/index.xml" rel="alternate" type="application/rss+xml" class="icons d-block">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a></li><li class="list-inline-item">
                            <a href="https://github.com/fskelly" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://linkedin.com/in/fletcherkelly" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://twitter.com/fskelly" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                </ul>

                <p class="text-muted">
                    
                        Copyright ¬© 2019‚Äì2021, Fletcher Kelly; all rights reserved.
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.d608eadfe5ac0688902e.min.js"></script>
        
    



<script>
    window.Prism = window.Prism || {};
    window.Prism.manual = true;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js"></script>







    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-XXXX', 'auto');
	
	ga('send', 'pageview');
}
</script>
</body>
</html>
